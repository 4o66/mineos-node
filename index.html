<!doctype html>
<html>
  <head>
    <title>MineOS Web User-Interface</title>
    <style>
      
    </style>
    <script type="text/javascript">
      String.prototype.format = function() {
        var s = this;
        for(var i = 0, iL = arguments.length; i<iL; i++) {
          s = s.replace(new RegExp('\\{'+i+'\\}', 'gm'), arguments[i]);
        }
        return s;
      };
    </script>

  </head>
  <body>
    <h1>mineos</h1>
    <h2>server list</h2>
    <ul id="servers"></ul>
    <h2>log.latest</h2>
    <ul id="log_latest"></ul>
    <h2>server.properties</h2>
    <ul id="sp"></ul>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var connect_string = ':3000/';
      var global = io(connect_string);
      var channels = {};

      global.on('server_list', function(servers) {
        console.log(servers);
        $('#servers').empty();
        for (var s in servers)
          track_server(servers[s]);
      })

      global.on('track_server', function(server_name) {
        track_server(server_name);
      })

      global.on('disconnect', function() {
        global.removeAllListeners();
      })

      function track_server(server_name) {
        if (server_name in channels)
          return;

        $('#servers').append($('<li>').text(server_name));
        var c = channels[server_name] = io(connect_string + server_name);

        c.on('server.properties', function(data) {
          $('#sp').empty();
          $.each(data, function(k,v) {
            $('#sp').append($('<li>').text('{0}:{1}'.format(k,v)));
          })
        })

        c.on('tail_data', function(data) {
          console.log('received tail data')
          $('#log_latest').append($('<li>').text(data))
        })

        c.on('result', function(data) {
          console.log('RESULT:', data);
        })

        c.on('receipt', function(data) {
          console.log('RECEIPT:', data);
        })
      }

      /*
      global.emit('command', {command: 'create', 'server_name': 'aaa'})
      channels['aaa'].emit('command', {command: 'start'})
      channels['aaa'].emit('command', {command: 'ping'})
      channels['aaa'].emit('command', {command: 'stuff', msg: 'stop'})
      channels['aaa'].emit('command', {command: 'backup'})
      channels['aaa'].emit('command', {command: 'archive'})
      */
    </script>
  </body>
</html>